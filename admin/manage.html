<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin — Manage Uploads</title>

  <link rel="stylesheet" href="../css/futuristic.css">
  <link rel="stylesheet" href="../css/theme.css">

  <style>
    .wrap { max-width:1200px; margin:28px auto; padding:0 18px; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .section { background:var(--card); padding:18px; border-radius:14px; border:1px solid var(--glass); box-shadow:var(--shadow); margin-top:20px; }
    .list { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .item { padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); display:flex; justify-content:space-between; align-items:center; gap:12px; border:1px solid rgba(0,0,0,0.04); }
    .meta { color:var(--muted); font-size:13px; }
    .title { font-weight:700; color:var(--text); font-size:18px; }
    .actions { display:flex; gap:10px; align-items:center; }
    .danger { background:#ff6b6b; color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .small-btn { padding:8px 12px; border-radius:10px; border:none; cursor:pointer; }
    .filter-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .badge { background:rgba(0,0,0,0.06); padding:6px 10px; border-radius:8px; font-weight:700; color:var(--muted); }
    .empty { color:var(--muted); padding:14px; text-align:center; }
    a.open-link { text-decoration:none; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; padding:8px 12px; border-radius:10px; font-weight:700; }
    select,input { padding:8px;border-radius:8px;border:1px solid var(--glass); background:transparent;color:var(--text) }
    @media(max-width:800px){ .top { flex-direction:column; align-items:flex-start } .item { flex-direction:column; align-items:flex-start } .actions { margin-top:8px } }
  </style>
</head>
<body>

  <header class="header-hero" style="height:160px;">
    <img src="../img/hero.png" alt="Hero">
    <div class="hero-content" style="top:28px; left:28px;">
      <h1>Admin — Manage Uploads</h1>
      <p style="color:var(--muted)">View, open or delete uploaded resources</p>
    </div>
  </header>

  <main class="wrap">

    <div class="top">
      <div>
        <div style="font-weight:800;font-size:18px">Manage uploads</div>
        <div class="meta" id="signedInfo">Checking sign-in...</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="goAdmin" class="small-btn glow-btn">Open Admin Panel</button>
        <button id="refreshBtn" class="small-btn glow-btn">Refresh</button>
      </div>
    </div>

    <!-- selector (choose which docId to manage) -->
    <div class="section">
      <div style="display:flex;flex-wrap:wrap;gap:12px;align-items:center">
        <div style="min-width:160px;">
          <label style="font-weight:700">Course</label>
          <select id="selCourse"></select>
        </div>
        <div style="min-width:160px;">
          <label style="font-weight:700">Branch</label>
          <select id="selBranch"></select>
        </div>
        <div style="min-width:160px;">
          <label style="font-weight:700">Semester</label>
          <select id="selSemester"></select>
        </div>
        <div style="min-width:260px;">
          <label style="font-weight:700">Subject</label>
          <select id="selSubject"></select>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="loadBtn" class="glow-btn">Load uploads</button>
          <div class="meta" id="currentPath" style="white-space:nowrap"></div>
        </div>
      </div>
    </div>

    <!-- list area -->
    <div id="listsContainer" class="section">
      <div id="itemsList" class="list"></div>
      <div id="empty" class="empty" style="display:none">No items found.</div>
    </div>
  </main>

  <!-- use the shared admin-common.js helpers; it exposes window.adminHelpers when loaded -->
  <script type="module" src="../js/admin-common.js"></script>

  <script type="module">
    import { auth, db, ADMIN_UID } from '../js/firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { collection, collectionGroup, query, orderBy, getDocs, getDocs as getDocsCol, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // DOM refs
    const signedInfo = document.getElementById('signedInfo');
    const itemsList = document.getElementById('itemsList');
    const emptyEl = document.getElementById('empty');
    const refreshBtn = document.getElementById('refreshBtn');
    const goAdmin = document.getElementById('goAdmin');
    const loadBtn = document.getElementById('loadBtn');
    const selCourse = document.getElementById('selCourse');
    const selBranch = document.getElementById('selBranch');
    const selSemester = document.getElementById('selSemester');
    const selSubject = document.getElementById('selSubject');
    const currentPathEl = document.getElementById('currentPath');

    // Populate selects (must match admin-common.js lists)
    const COURSES = ["B.Tech"];
    const BRANCHES = ["CSE","IT","AIML","AIDS","VLSI"];
    const COMMON_SEM12 = [
      "Applied Chemistry","Applied Mathematics I","Applied Physics I",
      "Communication Skills","Engineering Graphics","Engineering Mechanics",
      "Electrical Science","Environmental Science","Human Values and Professional Ethics",
      "Indian Constitution","Manufacturing Processes","Programming in C","Workshop Practice"
    ];
    const SUBJECTS_BY_BRANCH = {
      CSE:{3:["Digital Logic Design","Discrete Mathematics","Data Structures","Object Oriented Programming","Probability, Statistics & Linear Algebra","Foundation of Data Science","Principles of Artificial Intelligence","Computational Methods","Universal Human Values II"], 4:["Design and Analysis of Algorithms","Database Management Systems","Computer Organization","Operating Systems","Computer Networks","Software Engineering","Numerical Methods"]},
      IT:{3:["Digital Logic Design","Discrete Mathematics","Data Structures","Object Oriented Programming","Probability, Statistics & Linear Algebra","Foundation of Data Science","Principles of Artificial Intelligence","Computational Methods","Universal Human Values II"],4:["Database Management Systems","Operating Systems","Computer Networks","Web Technologies","Software Engineering","Internet of Things (Intro)"]},
      AIML:{3:["Data Structures","Discrete Mathematics","Probability, Statistics & Linear Algebra","Object Oriented Programming","Foundation of Data Science","Principles of Artificial Intelligence","Machine Learning Basics","Universal Human Values II"],4:["Machine Learning I","Data Mining","Linear Algebra for ML","Statistics for ML","Python for Data Science"]},
      AIDS:{3:["Data Structures","Discrete Mathematics","Probability, Statistics & Linear Algebra","Object Oriented Programming","Foundation of Data Science","Principles of Artificial Intelligence","Data Analysis Basics","Universal Human Values II"],4:["Machine Learning I","Data Visualization","APIs & Data Engineering Basics","Intro to Neural Networks"]},
      VLSI:{3:["Digital Logic Design","Electronic Devices and Circuits","Signals and Systems (intro)","Fundamentals of VLSI","Discrete Mathematics","Computational Methods"],4:["VLSI Design Basics","CMOS Technology","Microprocessors and Interfacing","Analog Circuits"]}
    };

    function fillSelects(){
      selCourse.innerHTML = COURSES.map(c=>`<option>${c}</option>`).join('');
      selBranch.innerHTML = BRANCHES.map(b=>`<option>${b}</option>`).join('');
      selSemester.innerHTML = [1,2,3,4].map(n=>`<option value="${n}">Semester ${n}</option>`).join('');
      fillSubjects();
      updatePath();
    }
    function fillSubjects(){
      const branch = selBranch.value;
      const sem = Number(selSemester.value);
      selSubject.innerHTML = '';
      let arr = [];
      if(sem === 1 || sem === 2) arr = COMMON_SEM12.slice();
      else arr = (SUBJECTS_BY_BRANCH[branch] && SUBJECTS_BY_BRANCH[branch][sem]) ? SUBJECTS_BY_BRANCH[branch][sem].slice() : [];
      arr.forEach(s => selSubject.appendChild(Object.assign(document.createElement('option'), { value:s, textContent:s })));
      selSubject.appendChild(Object.assign(document.createElement('option'), { value:'__other__', textContent:'— Add/Other —' }));
    }
    function updatePath(){ currentPathEl.innerText = `${selCourse.value} • ${selBranch.value} • Semester ${selSemester.value} • ${selSubject.value}`; }

    selBranch.addEventListener('change', ()=>{ fillSubjects(); updatePath(); });
    selSemester.addEventListener('change', ()=>{ fillSubjects(); updatePath(); });
    selSubject.addEventListener('change', updatePath);
    selCourse.addEventListener('change', updatePath);
    fillSelects();

    goAdmin.onclick = ()=> location.href = 'admin.html';
    refreshBtn.onclick = ()=> loadListForCurrent();

    // require admin login
    onAuthStateChanged(auth, user=>{
      if(!user){
        signedInfo.innerText = 'Not signed in — open Admin Panel to sign in';
        signedInfo.style.color = 'var(--muted)';
        itemsList.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.innerText = 'You must sign in as admin to manage uploads.';
        return;
      }
      if(user.uid !== ADMIN_UID){
        signedInfo.innerText = `Signed in as ${user.email} — not authorized`;
        itemsList.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.innerText = 'Your account is not authorized to manage uploads.';
        return;
      }
      signedInfo.innerText = `Signed in as ${user.email} (${user.uid})`;
      emptyEl.style.display = 'none';
      loadListForCurrent();
    });

    async function loadListForCurrent(){
      const subj = selSubject.value;
      if(!subj || subj === '__other__'){ alert('Choose a subject (or add in Admin Panel)'); return; }
      const docId = `${selCourse.value}__${selBranch.value}__Semester ${selSemester.value}__${subj}`;
      // call shared helper (admin-common.js exposes window.adminHelpers)
      if(window.adminHelpers && typeof window.adminHelpers.listUploadsFor === 'function'){
        // this helper fills a container with id 'manageList' by default — but our page uses itemsList.
        // We'll call the helper with our container id 'itemsList'
        await window.adminHelpers.listUploadsFor(docId, 'itemsList');
        // replace produced elements: admin-common.renderCard returns .card elements; our CSS expects .item
        // For compatibility, convert .card markup (if any) into .item style; but admin-common renders .card .card-title etc.
        // We'll leave the helper's output; if none, show empty message.
        if(document.getElementById('itemsList').children.length === 0){
          emptyEl.style.display = 'block';
          emptyEl.innerText = 'No uploads found for this subject.';
        } else {
          emptyEl.style.display = 'none';
        }
      } else {
        // fallback: manually query firestore collections
        await manualLoad(docId);
      }
      updatePath();
    }

    // fallback manual loader (if adminHelpers missing)
    async function manualLoad(docId){
      itemsList.innerHTML = '';
      const collectionsToCheck = ['notes','pyq','videos','practicals'];
      let found = 0;
      for(const col of collectionsToCheck){
        try{
          const q = query(collection(db, col, docId, 'items'), orderBy('timestamp','desc'));
          const snap = await getDocs(q);
          if(snap.empty) continue;
          snap.forEach(snapDoc=>{
            found++;
            const data = snapDoc.data();
            const title = data.title || '(no title)';
            const uploader = data.uploaderName || 'Admin';
            const link = data.driveLink || data.youtubeUrl || '';
            const itemEl = document.createElement('div'); itemEl.className = 'item';
            const left = document.createElement('div'); left.style.flex = '1';
            const t = document.createElement('div'); t.className = 'title'; t.innerText = title;
            const m = document.createElement('div'); m.className = 'meta'; m.innerText = `${col.toUpperCase()} • ${docId} ${uploader? ' • ' + uploader : ''}`;
            left.appendChild(t); left.appendChild(m);
            const actions = document.createElement('div'); actions.className = 'actions';
            if(link){
              const a = document.createElement('a'); a.className='open-link'; a.href = link; a.target='_blank'; a.rel='noopener'; a.innerText = 'Open';
              actions.appendChild(a);
            }
            const del = document.createElement('button'); del.className='danger'; del.innerText='Delete';
            del.onclick = async ()=>{ if(!confirm('Delete?')) return; await deleteDoc(doc(db, col, docId, 'items', snapDoc.id)); itemEl.remove(); };
            actions.appendChild(del);
            itemEl.appendChild(left); itemEl.appendChild(actions);
            itemsList.appendChild(itemEl);
          });
        }catch(e){
          console.error(e);
        }
      }
      if(found === 0){
        emptyEl.style.display = 'block';
        emptyEl.innerText = 'No uploads found for this subject.';
      } else emptyEl.style.display = 'none';
    }

    // hook load button
    loadBtn.addEventListener('click', () => loadListForCurrent());

    // initial
    // small defensive delay to let auth state settle
    setTimeout(()=>{ if(!auth.currentUser) signedInfo.innerText = 'Not signed in — open Admin Panel to sign in'; }, 700);

    // expose helper to allow admin-common delete to refresh this page, if they call window.adminHelpers.deleteItem
    window.manageRefresh = () => { loadListForCurrent(); };

  </script>

  <script type="module" src="../js/theme.js"></script>
</body>
</html>
